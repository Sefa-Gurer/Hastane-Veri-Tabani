{% extends "base.html" %}

{% block title %}Yeni Personel Ekle - Hastane Y√∂netim Sistemi{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>
                <i class="fas fa-user-plus text-primary"></i> 
                Yeni Personel Ekle
            </h1>
            <a href="{{ url_for('staff') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Personel Listesine D√∂n
            </a>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-id-badge"></i> Personel Bilgileri
                </h5>
            </div>
            <div class="card-body">
                <!-- Hata Mesajlarƒ± G√∂sterimi -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }}"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <form method="POST" action="{{ url_for('add_staff') }}" id="staffForm">
                    <!-- Ki≈üisel Bilgiler B√∂l√ºm√º -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-user"></i> Ki≈üisel Bilgiler
                            </h6>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tc" class="form-label">
                                <i class="fas fa-id-card text-muted"></i> TC Kimlik Numarasƒ± *
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="tc" 
                                   name="tc" 
                                   maxlength="11" 
                                   required
                                   placeholder="11 haneli TC kimlik no">
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i> 11 haneli TC kimlik numarasƒ± giriniz
                                <br><small class="text-muted">Test i√ßin: 12345678901</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="tel" class="form-label">
                                <i class="fas fa-phone text-muted"></i> Telefon *
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="tel" 
                                   name="tel" 
                                   maxlength="10" 
                                   required
                                   placeholder="5XXXXXXXXX">
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i> 5 ile ba≈ülayan 10 haneli numara
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ad" class="form-label">
                                <i class="fas fa-user text-muted"></i> Ad *
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="ad" 
                                   name="ad" 
                                   maxlength="50" 
                                   required
                                   placeholder="Personel adƒ±">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="soyad" class="form-label">
                                <i class="fas fa-user text-muted"></i> Soyad *
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="soyad" 
                                   name="soyad" 
                                   maxlength="50" 
                                   required
                                   placeholder="Personel soyadƒ±">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="email" class="form-label">
                            <i class="fas fa-envelope text-muted"></i> E-posta *
                        </label>
                        <input type="email" 
                               class="form-control" 
                               id="email" 
                               name="email" 
                               maxlength="225" 
                               required
                               placeholder="personel@hospital.com">
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> Ge√ßerli e-posta adresi giriniz
                        </div>
                    </div>
                    
                    <!-- Meslek Bilgileri B√∂l√ºm√º -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-briefcase"></i> Meslek Bilgileri
                            </h6>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="unvan_id" class="form-label">
                                <i class="fas fa-user-tie text-muted"></i> Unvan *
                            </label>
                            <select class="form-select" id="unvan_id" name="unvan_id" required>
                                <option value="">Unvan se√ßiniz...</option>
                                {% if unvanlar %}
                                    {% for unvan in unvanlar %}
                                        <option value="{{ unvan[0] }}">{{ unvan[1] }}</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="" disabled>Unvan bulunamadƒ±</option>
                                {% endif %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="poliklinik_id" class="form-label">
                                <i class="fas fa-hospital text-muted"></i> Poliklinik *
                            </label>
                            <select class="form-select" id="poliklinik_id" name="poliklinik_id" required>
                                <option value="">Poliklinik se√ßiniz...</option>
                                {% if poliklinikler %}
                                    {% for poliklinik in poliklinikler %}
                                        <option value="{{ poliklinik[0] }}">{{ poliklinik[1] }}</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="" disabled>Poliklinik bulunamadƒ±</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Form Butonlarƒ± -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-outline-secondary me-md-2" onclick="clearForm()">
                                    <i class="fas fa-undo"></i> Temizle
                                </button>
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <i class="fas fa-save"></i> Kaydet
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
console.log('üöÄ Add Staff Form y√ºklendi!');

// Debug mode
const DEBUG_MODE = true;

function log(...args) {
    if (DEBUG_MODE) {
        console.log('[ADD_STAFF]', ...args);
    }
}

// Form elements
const form = document.getElementById('staffForm');
const submitBtn = document.getElementById('submitBtn');

// Debug panel toggle (Development i√ßin)
if (DEBUG_MODE) {
    document.getElementById('debugPanel').style.display = 'block';
    updateDebugPanel();
}

// TC kimlik numarasƒ± sadece rakam giri≈üi
document.getElementById('tc').addEventListener('input', function() {
    // Sadece rakamlarƒ± al
    let value = this.value.replace(/\D/g, '');
    this.value = value;
    
    log('TC giri≈üi:', value);
    
    // 11 haneli kontrol
    if (value.length === 11) {
        this.classList.remove('is-invalid');
        this.classList.add('is-valid');
        log('TC 11 hane: OK');
    } else if (value.length > 0) {
        this.classList.remove('is-valid');
        this.classList.add('is-invalid');
    } else {
        this.classList.remove('is-valid', 'is-invalid');
    }
    
    updateDebugPanel();
});

// Telefon numarasƒ± sadece rakam giri≈üi
document.getElementById('tel').addEventListener('input', function() {
    // Sadece rakamlarƒ± al
    let value = this.value.replace(/\D/g, '');
    this.value = value;
    
    log('Telefon giri≈üi:', value);
    
    // 10 haneli ve 5 ile ba≈ülayan kontrol
    if (value.length === 10 && value.startsWith('5')) {
        this.classList.remove('is-invalid');
        this.classList.add('is-valid');
        log('Telefon 10 hane ve 5 ile ba≈ülƒ±yor: OK');
    } else if (value.length > 0) {
        this.classList.remove('is-valid');
        this.classList.add('is-invalid');
    } else {
        this.classList.remove('is-valid', 'is-invalid');
    }
    
    updateDebugPanel();
});

// Email validation
document.getElementById('email').addEventListener('input', function() {
    const value = this.value.trim();
    
    if (value.includes('@') && value.includes('.')) {
        this.classList.remove('is-invalid');
        this.classList.add('is-valid');
        log('Email ge√ßerli: OK');
    } else if (value.length > 0) {
        this.classList.remove('is-valid');
        this.classList.add('is-invalid');
    } else {
        this.classList.remove('is-valid', 'is-invalid');
    }
    
    updateDebugPanel();
});

// Select deƒüi≈üiklikleri i√ßin validation
document.getElementById('unvan_id').addEventListener('change', function() {
    if (this.value) {
        this.classList.add('is-valid');
        log('Unvan se√ßildi:', this.value);
    } else {
        this.classList.remove('is-valid');
    }
    updateDebugPanel();
});

document.getElementById('poliklinik_id').addEventListener('change', function() {
    if (this.value) {
        this.classList.add('is-valid');
        log('Poliklinik se√ßildi:', this.value);
    } else {
        this.classList.remove('is-valid');
    }
    updateDebugPanel();
});

// Form submit
form.addEventListener('submit', function(e) {
    log('Form submit ba≈ülƒ±yor...');
    
    // Submit butonunu disable et
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
    
    // Form verilerini log'la
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    log('Form verileri:', data);
    
    // Basit validation
    let isValid = true;
    let errors = [];
    
    if (!data.tc || data.tc.length !== 11) {
        isValid = false;
        errors.push('TC kimlik numarasƒ± 11 hane olmalƒ±dƒ±r');
    }
    
    if (!data.tel || data.tel.length !== 10 || !data.tel.startsWith('5')) {
        isValid = false;
        errors.push('Telefon numarasƒ± 5 ile ba≈ülayan 10 hane olmalƒ±dƒ±r');
    }
    
    if (!data.ad || !data.soyad || !data.email || !data.unvan_id || !data.poliklinik_id) {
        isValid = false;
        errors.push('T√ºm alanlarƒ± doldurunuz');
    }
    
    if (!isValid) {
        e.preventDefault();
        alert('Hatalar:\n' + errors.join('\n'));
        
        // Submit butonunu tekrar aktif et
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Kaydet';
        
        log('Form ge√ßersiz:', errors);
        return false;
    }
    
    log('Form ge√ßerli, sunucuya g√∂nderiliyor...');
    return true;
});

// Form temizleme
function clearForm() {
    log('Form temizleniyor...');
    form.reset();
    
    // T√ºm validation class'larƒ±nƒ± temizle
    form.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
        el.classList.remove('is-valid', 'is-invalid');
    });
    
    updateDebugPanel();
}

// Debug panel g√ºncelleme
function updateDebugPanel() {
    if (!DEBUG_MODE) return;
    
    const debugContent = document.getElementById('debugContent');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    debugContent.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Form Verileri:</h6>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            </div>
            <div class="col-md-6">
                <h6>Validation Durumu:</h6>
                <ul>
                    <li>TC: ${data.tc ? (data.tc.length === 11 ? '‚úÖ' : '‚ùå') : '‚è≥'} (${data.tc ? data.tc.length : 0}/11)</li>
                    <li>Telefon: ${data.tel ? (data.tel.length === 10 && data.tel.startsWith('5') ? '‚úÖ' : '‚ùå') : '‚è≥'} (${data.tel ? data.tel.length : 0}/10)</li>
                    <li>Email: ${data.email ? (data.email.includes('@') ? '‚úÖ' : '‚ùå') : '‚è≥'}</li>
                    <li>Unvan: ${data.unvan_id ? '‚úÖ' : '‚è≥'}</li>
                    <li>Poliklinik: ${data.poliklinik_id ? '‚úÖ' : '‚è≥'}</li>
                </ul>
            </div>
        </div>
    `;
}

log('JavaScript y√ºklendi ve hazƒ±r!');
</script>

<style>
.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.is-valid {
    border-color: #198754 !important;
}

.is-invalid {
    border-color: #dc3545 !important;
}

.card {
    border-radius: 15px;
    border: none;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}

.btn {
    border-radius: 25px;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
}

.border-bottom {
    border-bottom: 2px solid #dee2e6 !important;
}

pre {
    font-size: 0.8rem;
    max-height: 200px;
    overflow-y: auto;
}
</style>
{% endblock %}